<!DOCTYPE html>
<html class="x-admin-sm" xmlns:th="http://www.thymeleaf.org">
    
    <head>
        <meta charset="UTF-8">
        <title>欢迎页面-X-admin2.2</title>
        <header th:replace="header::html"></header>
    </head>
    <body>
    <div class="x-body">
        <form class="layui-form">
            <div class="layui-form-item">
                <input type="hidden" id="CodeName" th:value='${CodeName}'>
                <input type="hidden" id="parentCodeName" th:value='${parentCodeName}'>
                <label  class="layui-form-label">
                    <span class="x-red">*</span>视频名称
                </label>
                <div class="layui-input-inline">
                    <input type="hidden" id="cid" name="cid" th:value='${Course.cid}' lay-verify="cid">
                    <input type="text" id="name" name="name" th:value="${Course.name}" required="" lay-verify="name" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">
                    <span class="x-red">*</span>分类
                </label>
                <div class="layui-input-inline">
                    <span class="x-red">一级分类</span>
                    <select id="parentCode" name="parentCode" lay-filter="parentCode" >

                    </select>
                </div>
                <div class="layui-input-inline">
                    <span class="x-red">二级分类</span>
                    <select id="code" name="code" lay-filter="code"  >

                    </select>
                </div>

            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">
                    <span class="x-red">*</span>上传人
                </label>
                <div class="layui-input-inline">
                    <input type="text" id="username" name="username" th:value="${Course.username}" required="" lay-verify="username" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">难度</label>
                <div class="layui-input-inline">
                    <select id="level" name="level" lay-filter="level"  >
                        <option value="初级" th:selected="${Course.level =='初级'}" >初级</option>
                        <option value="中级" th:selected="${Course.level =='中级'}">中级</option>
                        <option value="高级" th:selected="${Course.level =='高级'}">高级</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">
                    <span class="x-red">*</span>简介
                </label>
                <div class="layui-input-inline">
                    <input type="text" id="brief" name="brief" required="" lay-verify="brief" autocomplete="off" th:value="${Course.brief}" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">
                    <span class="x-red">*</span>图片封面
                </label>
                <button type="button" class="layui-btn" id="imgurl">
                    <i class="layui-icon">&#xe67c;</i>上传图片
                </button>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">
                </label>
                <button  class="layui-btn" lay-filter="add" lay-submit="">
                    保存
                </button>
            </div>
        </form>
    </div>
        <script>
            var imgurl="";
            var parentCodeName,CodeName="";
            var CodeName=$("#CodeName").val();
            var parentCodeName=$("#parentCodeName").val();
            layui.use('upload', function(){
                var upload = layui.upload;

                //执行实例
                var uploadInst = upload.render({
                    elem: '#imgurl' //绑定元素
                    ,url: '/course/uploadcourseimg' //上传接口
                    ,done: function(res){
                        //上传完毕回调
                        imgurl=res.msg;
                        layer.alert("图片上传成功");
                    }
                    ,error: function(){
                        //请求异常回调
                        layer.alert("图片上传失败");
                    }
                });
            });
            layui.use(['form','layer'], function(){
                $ = layui.jquery;
                var form = layui.form,
                layer = layui.layer;

                <!--initData start-->
                if(parentCodeName==""||parentCodeName==undefined||parentCodeName==null) {
                    //第一个parentcode的值
                    getParentCode1();
                }else{
                    //渲染一级分类，二级分类
                    getParentCode(parentCodeName);
                }
                <!--initData end-->
                //自定义验证规则
                form.verify({
                });

                form.on('select(parentCode)',function (data) {
                    getCode(data.value)
                })

                //监听提交
                form.on('submit(add)', function(data){
                    //获取到role的值
                    var rolelRadio = $("[name=roleId]:checked");
                    if(rolelRadio == undefined || rolelRadio.length <= 0){
                        layer.alert("请给该用户设置角色");
                        return false;
                    }

                    data.field.roleId = rolelRadio.val();
                    console.log(rolelRadio.val())
                    //调用后端
                    $.ajax({
                        url:"/user/add",
                        type:"POST",
                        data:data.field,
                        dataType:'json',
                        success:function(result){
                            if(result.code == 500 || result.code == 5000100 || result.code == 5000101 || result.code == 5000102){
                                layer.alert(result.msg);
                            }else{
                                layer.alert("设置成功", {icon: 6},function () {
                                    //关闭当前frame
                                    xadmin.close();
                                    // 可以对父窗口进行刷新
                                    xadmin.father_reload();
                                });
                            }
                        }
                    });
                    return false;
                });

                function getParentCode1() {
                    //后台获取数据，渲染select父级
                    $.ajax({
                        url:"/course/fuCourseSortList",
                        type:"GET",
                        contentType: "application/json; charset=utf-8",
                        success:function(result){
                            var datas=result.datas;

                            //渲染
                            var parentCode=document.getElementById("parentCode");
                            var html="";
                            for(var i=0;i<datas.length;i++){
                                html+='<option value="'+datas[i].name+'">'+datas[i].name+'</option>';
                            }
                            parentCode.innerHTML=html;
                            getCode(datas[0].name);
                            form.render();
                        }
                    });
                }
                function getParentCode(parentCodeName) {
                    //后台获取数据，渲染select父级
                    $.ajax({
                        url:"/course/fuCourseSortList",
                        type:"GET",
                        contentType: "application/json; charset=utf-8",
                        success:function(result){
                            var datas=result.datas;
                            //渲染
                            var parentCode=document.getElementById("parentCode");
                            var html="";
                            for(var i=0;i<datas.length;i++){
                                if(parentCodeName==datas[i].name)
                                html+='<option selected="selected" value="'+datas[i].name+'">'+datas[i].name+'</option>';
                                else
                                html+='<option value="'+datas[i].name+'">'+datas[i].name+'</option>';
                            }
                            parentCode.innerHTML=html;
                            getCode2(parentCodeName,CodeName);
                            form.render();
                        }
                    });
                }
                function getCode2(parentCodeName) {
                    //后台获取数据，渲染select父级
                    $.ajax({
                        url:"/course/getcode?parentCodeName="+parentCodeName,
                        type:"GET",
                        contentType: "application/json; charset=utf-8",
                        success:function(result){
                             var datas=result.datas;
                             console.log(JSON.stringify(datas))
                            var code=document.getElementById("code");
                            if(datas==null){
                                console.log("没有二级")
                                var html="";
                                code.innerHTML=html;
                                form.render();
                            }
                            else{ //渲染
                                var html="";
                                for(var i=0;i<datas.length;i++){
                                    html+='<option value="'+datas[i].name+'">'+datas[i].name+'</option>';
                                }
                                code.innerHTML=html;
                                form.render();
                            }

                        }
                    });
                }
                function getCode(parentCodeName,CodeName) {
                    //后台获取数据，渲染select父级
                    $.ajax({
                        url:"/course/getcode?parentCodeName="+parentCodeName,
                        type:"GET",
                        contentType: "application/json; charset=utf-8",
                        success:function(result){
                            var datas=result.datas;
                            var code=document.getElementById("code");
                            if(datas==null){
                                var html="";
                                code.innerHTML=html;
                                form.render();
                            }
                            else{ //渲染
                                var html="";
                                for(var i=0;i<datas.length;i++){
                                    if(CodeName==datas[i].name)
                                    html+='<option selected="selected" value="'+datas[i].name+'">'+datas[i].name+'</option>';
                                    else
                                    html+='<option value="'+datas[i].name+'">'+datas[i].name+'</option>';
                                }
                                code.innerHTML=html;
                                form.render();
                            }

                        }
                    });
                }
                form.on('submit(add)', function(data) {
                    var isUpdata=false;
                    if(parentCodeName!=null||parentCodeName!=""||parentCodeName!=undefined){
                        isUpdata=true;
                    }
                    if(isUpdata){
                        data.field.imgurl=imgurl;
                        //调用后端
                        $.ajax({
                            url:"/course/editcoursepost",
                            type:"POST",
                            data:JSON.stringify(data.field),
                            dataType:'json',
                            contentType: "application/json; charset=utf-8",
                            success:function(result){
                                if(result.code == 500 || result.code == 5000100 || result.code == 5000101 || result.code == 5000102){
                                    layer.alert(result.msg);
                                }else{
                                    layer.alert("修改成功", {icon: 6},function () {
                                        //关闭当前frame
                                        xadmin.close();
                                        // 可以对父窗口进行刷新
                                        xadmin.father_reload();
                                    });
                                }
                            }
                        });
                    }else{
                        if(imgurl==""){
                            layer.alert("请先上传封面");
                        }else{
                            data.field.imgurl=imgurl;
                            //调用后端
                            $.ajax({
                                url:"/course/addcourse",
                                type:"POST",
                                data:JSON.stringify(data.field),
                                dataType:'json',
                                contentType: "application/json; charset=utf-8",
                                success:function(result){
                                    if(result.code == 500 || result.code == 5000100 || result.code == 5000101 || result.code == 5000102){
                                        layer.alert(result.msg);
                                    }else{
                                        layer.alert("添加成功", {icon: 6},function () {
                                            //关闭当前frame
                                            xadmin.close();
                                            // 可以对父窗口进行刷新
                                            xadmin.father_reload();
                                        });
                                    }
                                }
                            });
                        }
                    }
                    return false;
                });
            });

        </script>

    </body>

</html>
